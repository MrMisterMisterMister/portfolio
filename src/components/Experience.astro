---
import Section from "@/components/layout/Section.astro";
import Stack from "@/components/layout/Stack.astro";
import Grid from "@/components/layout/Grid.astro";
import Card from "@/components/ui/Card.astro";
import CardContent from "@/components/ui/CardContent.astro";
import CardDescription from "@/components/ui/CardDescription.astro";
import CardHeader from "@/components/ui/CardHeader.astro";
import CardTitle from "@/components/ui/CardTitle.astro";
import Badge from "@/components/ui/Badge.astro";
import Button from "@/components/ui/Button.astro";
import Separator from "@/components/ui/Separator.astro";
import Icon from "@/components/ui/Icon.astro";
import FadeIn from "@/components/animations/FadeIn";
import SlideIn from "@/components/animations/SlideIn";
import StaggerContainer from "@/components/animations/StaggerContainer";
import StaggerItem from "@/components/animations/StaggerItem";
import { experiences, education, certifications } from "@/lib/experienceData";
---

<Section id="experience">
    <Stack gap="base">
        <FadeIn client:load delay={0.1} duration={0.5}>
            <Stack gap="sm" as="header">
                <h2 class="text-3xl font-bold">Experience & Education</h2>
                <p class="text-muted">My professional journey and qualifications</p>
            </Stack>
        </FadeIn>

        {/* Work Experience */}
        <Stack gap="lg">
            <SlideIn client:load delay={0.2} direction="left" duration={0.6}>
                <div class="section-title-with-icon">
                    <Icon name="briefcase" size={24} class="icon-lg icon-primary" />
                    <h3 class="text-2xl font-semibold">Work Experience</h3>
                </div>
            </SlideIn>

            <StaggerContainer client:load delay={0.3} staggerDelay={0.2}>
                <Stack gap="lg">
                    {
                        experiences.map((exp, index) => (
                            <StaggerItem client:load>
                                <div>
                                    <Card>
                                        <CardHeader>
                                            <div class="experience-header">
                                                <div>
                                                    <CardTitle>{exp.role}</CardTitle>
                                                    <CardDescription class="text-base font-medium text-foreground experience-company">
                                                        {exp.company}
                                                    </CardDescription>
                                                </div>
                                                <div class="experience-meta">
                                                    <div>{exp.duration}</div>
                                                    <div>{exp.location}</div>
                                                </div>
                                            </div>
                                        </CardHeader>
                                        <CardContent>
                                            <ul class="experience-list">
                                                {exp.description.map((item) => (
                                                    <li class="experience-list-item">
                                                        <span class="text-primary experience-bullet">â€¢</span>
                                                        <span>{item}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </CardContent>
                                    </Card>
                                    {index < experiences.length - 1 && (
                                        <div class="experience-connector">
                                            <div class="connector-line" />
                                        </div>
                                    )}
                                </div>
                            </StaggerItem>
                        ))
                    }
                </Stack>
            </StaggerContainer>
        </Stack>

        <Separator />

        {/* Education */}
        <Stack gap="lg">
            <SlideIn client:load delay={0.5} direction="left" duration={0.6}>
                <div class="section-title-with-icon">
                    <Icon name="graduationCap" size={24} class="icon-lg icon-primary" />
                    <h3 class="text-2xl font-semibold">Education</h3>
                </div>
            </SlideIn>

            <StaggerContainer client:load delay={0.6} staggerDelay={0.15}>
                <Grid columns={2} gap="lg">
                    {
                        education.map((edu) => (
                            <StaggerItem client:load>
                                <Card>
                                    <CardHeader>
                                        <CardTitle class="text-xl">{edu.degree}</CardTitle>
                                        <CardDescription class="text-base">{edu.field}</CardDescription>
                                    </CardHeader>
                                    <CardContent>
                                        <Stack gap="sm">
                                            <p class="font-medium">{edu.institution}</p>
                                            <p class="text-sm text-muted">{edu.duration}</p>
                                            {edu.description && (
                                                <p class="text-sm text-muted">{edu.description}</p>
                                            )}
                                        </Stack>
                                    </CardContent>
                                </Card>
                            </StaggerItem>
                        ))
                    }
                </Grid>
            </StaggerContainer>
        </Stack>

        <Separator />

        {/* Certifications */}
        <Stack gap="lg">
            <SlideIn client:load delay={0.8} direction="left" duration={0.6}>
                <div class="section-title-with-icon">
                    <Icon name="award" size={24} class="icon-lg icon-primary" />
                    <h3 class="text-2xl font-semibold">Certifications</h3>
                </div>
            </SlideIn>

            <StaggerContainer client:load delay={0.9} staggerDelay={0.1}>
                <Grid columns={3} gap="lg">
                    {
                        certifications.map((cert) => (
                            <StaggerItem client:load>
                                <Card>
                                    <CardHeader>
                                        <CardTitle class="text-lg">{cert.name}</CardTitle>
                                        <CardDescription>{cert.issuer}</CardDescription>
                                    </CardHeader>
                                    <CardContent>
                                        <Stack gap="base">
                                            <Badge variant="outline">{cert.date}</Badge>
                                            {cert.credentialUrl && cert.credentialType === "url" && (
                                                <Button
                                                    variant="link"
                                                    size="sm"
                                                    class="p-0 h-auto"
                                                    href={cert.credentialUrl}
                                                >
                                                    <a
                                                        href={cert.credentialUrl}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        class="cert-link"
                                                    >
                                                        <Icon name="externalLink" size={12} class="cert-icon" />
                                                        View Credential
                                                    </a>
                                                </Button>
                                            )}
                                            {cert.credentialFile && cert.credentialType === "pdf" && (
                                                <button
                                                    class="cert-view-btn"
                                                    data-cert-id={cert.id}
                                                    data-cert-file={cert.credentialFile}
                                                    data-cert-name={cert.name}
                                                    data-cert-type="pdf"
                                                    type="button"
                                                >
                                                    <Icon name="externalLink" size={12} class="cert-icon" />
                                                    View Certificate
                                                </button>
                                            )}
                                            {cert.credentialFile && cert.credentialType === "image" && (
                                                <button
                                                    class="cert-view-btn"
                                                    data-cert-id={cert.id}
                                                    data-cert-file={cert.credentialFile}
                                                    data-cert-name={cert.name}
                                                    data-cert-type="image"
                                                    type="button"
                                                >
                                                    <Icon name="externalLink" size={12} class="cert-icon" />
                                                    View Certificate
                                                </button>
                                            )}
                                        </Stack>
                                    </CardContent>
                                </Card>
                            </StaggerItem>
                        ))
                    }
                </Grid>
            </StaggerContainer>
        </Stack>
    </Stack>

    <!-- Certificate Viewer Modal for PDF and Image -->
    <div id="cert-viewer-modal" class="cert-viewer-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="cert-viewer-backdrop"></div>
        <div class="cert-viewer-content">
            <button class="cert-viewer-close" aria-label="Close certificate viewer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="cert-viewer-header">
                <h3 id="cert-viewer-title"></h3>
            </div>
            <div id="cert-viewer-container" class="cert-viewer-container"></div>
        </div>
    </div>
</Section>

<script>
    // Certificate viewer functionality
    const certViewerModal = document.getElementById("cert-viewer-modal");
    const certViewerContainer = document.getElementById("cert-viewer-container");
    const certViewerTitle = document.getElementById("cert-viewer-title");
    const certViewerClose = document.querySelector(".cert-viewer-close");
    const certViewerBackdrop = document.querySelector(".cert-viewer-backdrop");

    // Open certificate viewer
    const openCertViewer = (file: string, name: string, type: string) => {
        if (!certViewerModal || !certViewerContainer || !certViewerTitle) return;

        certViewerTitle.textContent = name;
        certViewerContainer.innerHTML = "";

        if (type === "pdf") {
            // Create iframe for PDF
            const iframe = document.createElement("iframe");
            iframe.src = file;
            iframe.className = "cert-pdf-viewer";
            iframe.title = `${name} Certificate PDF`;
            certViewerContainer.appendChild(iframe);
        } else if (type === "image") {
            // Create image element
            const img = document.createElement("img");
            img.src = file;
            img.alt = `${name} Certificate`;
            img.className = "cert-image-viewer";
            certViewerContainer.appendChild(img);
        }

        certViewerModal.classList.add("active");
        certViewerModal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
    };

    // Close certificate viewer
    const closeCertViewer = () => {
        if (!certViewerModal || !certViewerContainer) return;

        certViewerModal.classList.remove("active");
        certViewerModal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        certViewerContainer.innerHTML = "";
    };

    // Event delegation for certificate view buttons
    document.addEventListener("click", (e) => {
        const btn = (e.target as HTMLElement).closest(".cert-view-btn");
        if (btn) {
            const file = btn.getAttribute("data-cert-file");
            const name = btn.getAttribute("data-cert-name");
            const type = btn.getAttribute("data-cert-type");

            if (file && name && type) {
                openCertViewer(file, name, type);
            }
        }
    });

    // Close handlers
    if (certViewerClose) {
        certViewerClose.addEventListener("click", closeCertViewer);
    }

    if (certViewerBackdrop) {
        certViewerBackdrop.addEventListener("click", closeCertViewer);
    }

    // ESC key handler
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && certViewerModal?.classList.contains("active")) {
            closeCertViewer();
        }
    });
</script>
